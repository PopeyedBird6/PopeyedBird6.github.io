<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Samoyedos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-responsive { margin-top: 20px; }
        .error-message { color: red; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">🐾 Productos para Samoyedos</h1>

       
        <form id="formProducto" class="mb-5 border p-4 rounded">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Nombre</label>
                    <input type="text" name="nombre" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Descripción</label>
                    <textarea name="descripcion" class="form-control" required></textarea>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Precio ($)</label>
                    <input type="number" step="0.01" name="precio" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Stock</label>
                    <input type="number" name="stock" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Categoría</label>
                    <input type="text" name="categoria" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">SKU</label>
                    <input type="text" name="sku" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Marca</label>
                    <input type="text" name="marca" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Color</label>
                    <input type="text" name="color" class="form-control" required>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Registrar Producto</button>
                </div>
            </div>
        </form>

        <!-- Tabla de Productos -->
        <div class="table-responsive">
            <h3>Lista de Productos</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaProductos">
                    <!-- Los registros se cargan aquí -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
    // Variables globales para edición
    let editando = false;
    let productoIdActual = null;

    // Cargar registros al iniciar
    document.addEventListener('DOMContentLoaded', () => {
        cargarRegistros();
    });

    // Enviar formulario con AJAX (CREAR/ACTUALIZAR)
    document.getElementById('formProducto').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Configurar método y URL según modo
        const url = editando ? `/productos/${productoIdActual}` : '/productos';
        const method = editando ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.errors) {
                alert(`Error: ${result.errors[0].msg}`);
            } else {
                // Resetear estado y actualizar
                editando = false;
                productoIdActual = null;
                await cargarRegistros(); 
                e.target.reset();
                document.querySelector('button[type="submit"]').textContent = 'Registrar Producto';
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    // Función para cargar/actualizar registros
    async function cargarRegistros() {
        try {
            const response = await fetch('/productos');
            const productos = await response.json();
            const tbody = document.getElementById('tablaProductos');
            
            tbody.innerHTML = ''; // Limpiar tabla

            productos.forEach(producto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${producto.id}</td>
                    <td>${producto.nombre}</td>
                    <td>$${producto.precio}</td>
                    <td>${producto.stock}</td>
                    <td>
                        <button class="btn btn-sm btn-danger me-2" onclick="eliminarProducto(${producto.id})">Eliminar</button>
                        <button class="btn btn-sm btn-warning" onclick="cargarParaEditar(${producto.id})">Editar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Función para cargar datos en formulario
    async function cargarParaEditar(id) {
        try {
            const response = await fetch(`/productos/${id}`);
            const producto = await response.json();
            
            // Llenar formulario
            const form = document.getElementById('formProducto');
            Object.keys(producto).forEach(key => {
                if (form.elements[key]) {
                    form.elements[key].value = producto[key];
                }
            });
            
            // Cambiar a modo edición
            editando = true;
            productoIdActual = id;
            form.querySelector('button[type="submit"]').textContent = 'Actualizar Producto';
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Función para eliminar producto
    async function eliminarProducto(id) {
        if (confirm('¿Estás seguro de eliminar este producto?')) {
            try {
                await fetch(`/productos/${id}`, { method: 'DELETE' });
                await cargarRegistros(); //Actualizar tabla después de eliminar
            } catch (error) {
                console.error('Error:', error);
            }
        }
    }
    </script>
</body>
</html>